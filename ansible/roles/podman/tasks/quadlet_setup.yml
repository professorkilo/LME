---
# Quadlet setup tasks for podman role

- name: Copy config files /opt/lme/config
  copy:
    src: "{{ clone_directory }}/config/"
    dest: /opt/lme/config/
    owner: "{{ install_user }}"
    group: "{{ install_user }}"
    mode: '0644'
  become: yes

# Configure Kibana for offline/air-gapped mode BEFORE starting services
# This must happen after config files are copied but before LME service starts
- name: Configure Kibana for offline mode
  blockinfile:
    path: /opt/lme/config/kibana.yml
    marker: "# {mark} ANSIBLE MANAGED BLOCK - OFFLINE MODE"
    block: |
      xpack.fleet.registryUrl: "https://lme-fleet-distribution:8080"
      xpack.fleet.isAirGapped: true
  become: yes
  when: offline_mode | default(false)

- name: Create /etc/containers/systemd
  file:
    path: /etc/containers/systemd
    state: directory
    owner: "root"
    group: "root"
    mode: '0744'
  become: yes

- name: Copy quadlet files to /etc/containers/systemd 
  copy:
    src: "{{ clone_directory }}/quadlet/"
    dest: /etc/containers/systemd/
    owner: "root"
    group: "root"
    mode: '0644'
  become: yes

- name: copy lme.service to /etc/systemd/system
  copy:
    src: "{{ clone_directory }}/quadlet/lme.service"
    dest: "/etc/systemd/system/lme.service"
    owner: "root"
    group: "root"
    mode: '0644'
  become: yes

# Ensure quadlet helper and systemd generator are available from standard paths
# Skip for RHEL offline mode - system podman already has these in place
- name: Ensure /usr/libexec/podman exists
  file:
    path: /usr/libexec/podman
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  when: not (offline_mode | default(false) and ansible_os_family == "RedHat")

- name: Link quadlet helper into /usr/libexec/podman
  file:
    src: /nix/var/nix/profiles/default/libexec/podman/quadlet
    dest: /usr/libexec/podman/quadlet
    state: link
    force: true
  become: yes
  when: not (offline_mode | default(false) and ansible_os_family == "RedHat")

- name: Ensure podman systemd generator is linked
  file:
    src: /nix/var/nix/profiles/default/libexec/podman/quadlet
    dest: /usr/lib/systemd/system-generators/podman-system-generator
    state: link
    force: true
  become: yes
  when: not (offline_mode | default(false) and ansible_os_family == "RedHat")

- name: Restore contexts on quadlet/generator paths (best-effort)
  command: restorecon -v /usr/libexec/podman/quadlet /usr/lib/systemd/system-generators/podman-system-generator
  changed_when: false
  failed_when: false
  become: yes
  when: not (offline_mode | default(false) and ansible_os_family == "RedHat")

# For RHEL offline mode - verify system podman quadlet is available
- name: Verify system podman quadlet exists (RHEL offline)
  stat:
    path: /usr/libexec/podman/quadlet
  register: system_podman_quadlet
  when: offline_mode | default(false) and ansible_os_family == "RedHat"

- name: Fail if system podman quadlet not found (RHEL offline)
  fail:
    msg: "System podman quadlet not found. Please ensure podman RPM is properly installed."
  when:
    - offline_mode | default(false) and ansible_os_family == "RedHat"
    - not system_podman_quadlet.stat.exists

# ---------------------------------------------------------------------------
# Apply SELinux contexts after podman installation and symlink creation
# ---------------------------------------------------------------------------

# Apply SELinux contexts to paths (now that podman_policy module defines the contexts)
- name: Apply SELinux contexts to system generator paths (if they exist)
  command: restorecon -Rv "{{ item }}"
  changed_when: false
  failed_when: false
  become: yes
  loop:
    - "/usr/libexec/podman/quadlet"
    - "/usr/lib/systemd/system-generators/podman-system-generator"
    - "/usr/lib/systemd/system-generators"
    - "/etc/systemd/system-generators"  # May be created by systemd after module load
    - "/etc/containers/systemd"
  when:
    - selinux_available | default(false)
    - (getenforce_out.stdout | default('') | trim) != 'Disabled'

- name: Apply SELinux contexts to Nix paths (final podman restorecon)
  command: restorecon -Rv "{{ item }}"
  changed_when: false
  failed_when: false
  become: yes
  loop:
    - "/nix/var/nix/profiles/default"
    - "/nix/store"
  when:
    - selinux_available | default(false)
    - (getenforce_out.stdout | default('') | trim) != 'Disabled'
    - not (offline_mode | default(false) and ansible_os_family == "RedHat")

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  become: yes

- name: Start LME service
  systemd:
    name: lme.service
    state: started
    enabled: yes
  become: yes 